<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Home Page</title>
    <link rel="stylesheet" href="main.css" />
  </head>
  <body class="max-w-1020">
    <h1 class="title">Moogle</h1>
    <div>
      <form class="search-form">
        <input
          type="text"
          class="search-input"
          placeholder="Enter keyword"
          name="keyword"
        />
        <button type="submit" class="search-submit-button">Search</button>
      </form>
    </div>
    <div class="search-results">
      <div class="movie-filter">
        <form>
          <input class="movie-filter-order-by"/>
        </form>
      </div>
      <div>
        <div class="movie-list"></div>
        <div class="infinite-scroll-trigger"></div>
      </div>
    </div>
  </body>
  <script>
    let movieData = []

    const params = new URLSearchParams(window.location.search);

    const keyword = params.get('keyword');
    const orderBy = params.get('orderBy');

    if(keyword){
        document.querySelector(".search-input").value = keyword;
    }
    if(orderBy){
        document.querySelector(".movie-filter-order-by").value = orderBy;
    }

    const observer = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          addMovies()
          const parent = document.querySelector('.movie-list');
          const childCount = parent.children.length;

          console.log(`${childCount}`);
        }
      });
    });

    const target = document.querySelector('.infinite-scroll-trigger');
    observer.observe(target);

    function createMovieItem(movie){
      return `<div class="movie-item">
                <div class="movie-item-image">
                   <img src="${movie?.poster_path}" alt="${movie?.title}" class="movie-item-poster" onerror="this.onerror=null; this.src='./poster-image-not-found.png';"/>
                   </div>
                <div class="movie-item-info">
                <h2 class="movie-item-title">${movie.title}</h2>
                <p>${movie.release_date}</p>
                <p>${movie.vote_average}</p>
                </div>
              </div>`
    }

    function addMovies(){
      const tagetMovies = movieData.splice(0,20)
      document.querySelector(".movie-list").innerHTML = document.querySelector(".movie-list").innerHTML + tagetMovies
              .slice(0, 20)
              .map(
                      (movie) => createMovieItem(movie),
              )
              .join("");
    }

    fetch("./product.json")
      .then((response) => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then((data) => {
        movieData = data;
        if(keyword){
          movieData = movieData.filter((movie) => {
            return (
                    JSON.stringify(movie).toLowerCase().replaceAll(" ", "").includes(keyword.replaceAll(" ", "").toLowerCase())
            );
          });
        }
        addMovies();
      })
      .catch((error) => {
        console.error("Fetch error:", error);
      });
  </script>
</html>
